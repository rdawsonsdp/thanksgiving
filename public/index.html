<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Planning Dashboard</title>
    <!-- Google Fonts for Brown Sugar Bakery Theme -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tenor+Sans&family=Assistant:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Flatpickr Calendar Widget -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --header-font-style: normal;
            --nav-font-family: "Tenor Sans", sans-serif;
            --button-text-color: #ffffff;
            --pop-up-text: #292929;
            --subpage-header: 20;
            --body-font-stack: "Tenor Sans", sans-serif;
            --jdgm-secondary-color: rgba(233,141,61,0.1);
            --heading-font-size: 28px;
            --subheading-case: none;
            --color-image-overlay: #292929;
            --subheading-font-stack: Assistant, sans-serif;
            --pop-up-background: #fafafa;
            --swiper-theme-color: #007aff;
            --border-color-subtle-darken: #461c0e;
            --error-color: #b94a48;
            --free-shipping-background: #dfdfdf;
            --sale-text-color: #fafafa;
            --warning: #ffc107;
            --orange: #fd7e14;
            --header-font-weight: 600;
            --green: #28a745;
            --nav-font-weight: 400;
            --subheading-font-style: normal;
            --subheading-2-line-height: 20px;
            --jdgm-paginate-color: #E98D3D;
            --jdgm-reviewer-name-color: #E98D3D;
            --subheading-line-height: 22px;
            --button-font-family: "Tenor Sans", sans-serif;
            --subheading-base: 14;
            --danger: #dc3545;
            --subpage-header-px: 20px;
            --jdgm-primary-color: #E98D3D;
            --password-btn-background: rgba(0, 0, 0, 1);
            --sticky-header-top-bar: #dcdcdc;
            --header-border-color: #5b2512;
            --password-login-background: #111111;
            --heading-line-height: 36px;
            --body-font-style: normal;
            --header-text: #ffffff;
            --password-btn-background-hover: rgba(125, 125, 125, .6);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--body-font-stack);
            font-style: var(--body-font-style);
            background: var(--pop-up-background);
            color: var(--pop-up-text);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: var(--header-border-color);
            color: var(--header-text);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--jdgm-primary-color);
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo {
            height: 60px;
            width: auto;
        }
        
        .header-content {
            flex: 1;
        }
        
        h1 {
            font-family: var(--nav-font-family);
            font-weight: var(--header-font-weight);
            font-size: var(--heading-font-size);
            line-height: var(--heading-line-height);
            margin-bottom: 10px;
            color: var(--header-text);
        }
        
        .subtitle {
            font-family: var(--subheading-font-stack);
            font-style: var(--subheading-font-style);
            opacity: 0.9;
            font-size: 1.1em;
            line-height: var(--subheading-line-height);
        }
        
        .filters {
            background: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filters h2 {
            font-family: var(--nav-font-family);
            font-weight: var(--header-font-weight);
            margin-bottom: 20px;
            color: var(--jdgm-primary-color);
        }
        
        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-item {
            display: flex;
            flex-direction: column;
        }
        
        .filter-item label {
            font-family: var(--nav-font-family);
            font-weight: var(--nav-font-weight);
            margin-bottom: 8px;
            color: var(--pop-up-text);
        }
        
        .filter-item input,
        .filter-item select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .filter-item input:focus,
        .filter-item select:focus {
            outline: none;
            border-color: var(--jdgm-primary-color);
        }
        
        .quick-date-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .quick-filter-btn {
            font-family: var(--button-font-family);
            padding: 8px 16px;
            background: var(--pop-up-background);
            border: 2px solid var(--border-color-subtle-darken);
            border-radius: 5px;
            font-size: 14px;
            font-weight: var(--nav-font-weight);
            color: var(--pop-up-text);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-filter-btn:hover {
            background: var(--jdgm-primary-color);
            border-color: var(--jdgm-primary-color);
            color: var(--button-text-color);
        }
        
        .quick-filter-btn.active {
            background: var(--jdgm-primary-color);
            border-color: var(--jdgm-primary-color);
            color: var(--button-text-color);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-card h3 {
            color: #999;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-family: var(--nav-font-family);
            font-size: 2em;
            font-weight: bold;
            color: var(--jdgm-primary-color);
        }
        
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-container h3 {
            font-family: var(--nav-font-family);
            margin-bottom: 15px;
            color: var(--jdgm-primary-color);
        }
        
        .data-table {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .data-table h2 {
            font-family: var(--nav-font-family);
            font-weight: var(--header-font-weight);
            margin-bottom: 20px;
            color: var(--jdgm-primary-color);
        }
        
        /* Tab Styles */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-button {
            background: transparent;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            margin-bottom: -2px;
        }
        
        .tab-button:hover {
            color: var(--jdgm-primary-color);
            background: var(--pop-up-background);
        }
        
        .tab-button.active {
            color: var(--jdgm-primary-color);
            border-bottom-color: var(--jdgm-primary-color);
            font-weight: var(--header-font-weight);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            font-family: var(--nav-font-family);
            background: var(--sticky-header-top-bar);
            font-weight: var(--header-font-weight);
            color: var(--pop-up-text);
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: var(--pop-up-background);
        }
        
        tr.date-group-header {
            background-color: #f0f0f0 !important;
        }
        
        tr.date-group-header:hover {
            background-color: var(--free-shipping-background) !important;
        }
        
        tr.date-group-header td {
            font-family: var(--nav-font-family);
            font-weight: bold;
            padding: 12px;
            border-bottom: 2px solid var(--jdgm-primary-color);
            background-color: var(--sticky-header-top-bar);
        }
        
        tr.date-group-header + tr {
            background-color: #fafafa;
        }
        
        /* Shaded background for all rows in a date group */
        tr.date-group-header ~ tr:not(.date-group-header) {
            background-color: #fafafa;
        }
        
        /* Reset background when we hit the next date group */
        tr.date-group-header ~ tr.date-group-header ~ tr:not(.date-group-header) {
            background-color: #fafafa;
        }
        
        /* Add spacing between date groups */
        tr.date-group-header {
            margin-top: 10px;
        }
        
        /* Ensure proper background for rows between groups */
        tbody tr:not(.date-group-header) {
            background-color: #fafafa;
        }
        
        tbody tr:not(.date-group-header):hover {
            background-color: var(--free-shipping-background);
        }
        
        .order-header-row {
            background-color: var(--jdgm-secondary-color) !important;
            font-weight: bold;
            border-top: 2px solid var(--jdgm-primary-color);
        }
        
        .order-header-row:hover {
            background-color: rgba(233,141,61,0.2) !important;
        }
        
        .line-item-row {
            background-color: #fafafa;
        }
        
        .line-item-row:hover {
            background-color: #f0f0f0;
        }
        
        .single-item-row {
            background-color: #ffffff;
        }
        
        .line-item-row td:first-child {
            border-left: 3px solid var(--jdgm-primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .error {
            background: var(--error-color);
            color: var(--button-text-color);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        button {
            font-family: var(--button-font-family);
            background: var(--password-btn-background);
            color: var(--button-text-color);
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: var(--password-btn-background-hover);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        @media print {
            .btn-group,
            .filters,
            .charts,
            header,
            .no-print {
                display: none !important;
            }
            .data-table {
                display: block !important;
            }
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            thead {
                display: table-header-group;
            }
            .date-group-header {
                page-break-after: avoid;
            }
        }
        
        .multiselect-dropdown {
            position: relative;
            width: 100%;
        }
        
        .multiselect-header {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: border-color 0.3s;
        }
        
        .multiselect-header:hover {
            border-color: var(--jdgm-primary-color);
        }
        
        .dropdown-arrow {
            font-size: 12px;
            color: #999;
            transition: transform 0.3s;
        }
        
        .multiselect-dropdown.open .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .multiselect-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 5px 5px;
            max-height: 300px;
            overflow: hidden;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        
        .product-search-container {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .product-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
        }
        
        .product-search:focus {
            border-color: var(--jdgm-primary-color);
            box-shadow: 0 0 0 2px var(--jdgm-secondary-color);
        }
        
        #productOptionsList {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        .multiselect-option {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .multiselect-option:hover {
            background: #f8f9fa;
        }
        
        .multiselect-option input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .multiselect-option span {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="bsb-horizontal-logo-full-color-rgb_600x.svg" alt="Brown Sugar Bakery Logo" class="logo">
            <div class="header-content">
                <h1>Order Planning Dashboard</h1>
                <p class="subtitle">Interactive order information viewer with filtering capabilities</p>
            </div>
        </header>
        
        <div class="filters">
            <h2>üîç Filters</h2>
            <div class="filter-group">
                <div class="filter-item">
                    <label>Pickup Dates (Select Multiple)</label>
                    <input type="text" id="pickupDateCalendar" placeholder="Click to select dates..." readonly>
                    <div id="pickupDateDisplay" style="margin-top: 8px; font-size: 12px; color: #666;">
                        <span id="pickupDateCount">All dates selected</span>
                    </div>
                </div>
                <div class="filter-item" style="grid-column: 1 / -1;">
                    <label>Quick Date Filters</label>
                    <div class="quick-date-filters">
                        <button type="button" class="quick-filter-btn" onclick="setQuickDateFilter('today', this)">Today</button>
                        <button type="button" class="quick-filter-btn" onclick="setQuickDateFilter('7days', this)">Last 7 Days</button>
                        <button type="button" class="quick-filter-btn" onclick="setQuickDateFilter('30days', this)">Last 30 Days</button>
                        <button type="button" class="quick-filter-btn" onclick="setQuickDateFilter('mtd', this)">Month to Date</button>
                    </div>
                </div>
                <div class="filter-item" style="position: relative;">
                    <label>Order Type (Multi-select)</label>
                    <div class="multiselect-dropdown" id="orderTypeMultiselect">
                        <div class="multiselect-header" onclick="toggleOrderTypeDropdown()">
                            <span id="orderTypeSelectText">All Order Types</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="multiselect-options" id="orderTypeOptions" style="display: none;">
                            <div class="product-search-container">
                                <input type="text" id="orderTypeSearch" class="product-search" placeholder="Search order types..." oninput="filterOrderTypes(this.value)">
                            </div>
                            <div id="orderTypeOptionsList">
                                <label class="multiselect-option">
                                    <input type="checkbox" value="All Order Types" checked onchange="handleOrderTypeSelect(this, true)">
                                    <span>All Order Types</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-item" style="position: relative;">
                    <label>Products (Multi-select)</label>
                    <div class="multiselect-dropdown" id="productMultiselect">
                        <div class="multiselect-header" onclick="toggleProductDropdown()">
                            <span id="productSelectText">All Products</span>
                            <span class="dropdown-arrow">‚ñº</span>
                        </div>
                        <div class="multiselect-options" id="productOptions" style="display: none;">
                            <div class="product-search-container">
                                <input type="text" id="productSearch" class="product-search" placeholder="Search products..." oninput="filterProducts(this.value)">
                            </div>
                            <div id="productOptionsList">
                                <label class="multiselect-option">
                                    <input type="checkbox" value="All Products" checked onchange="handleProductSelect(this, true)">
                                    <span>All Products</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-item">
                    <label>Order Date Start</label>
                    <input type="date" id="dateStart">
                </div>
                <div class="filter-item">
                    <label>Order Date End</label>
                    <input type="date" id="dateEnd">
                </div>
            </div>
            <button onclick="loadData()">Apply Filters</button>
            <button onclick="resetFilters()">Reset</button>
        </div>
        
        <div id="errorMessage" class="error" style="display: none;"></div>
        
        <div id="loading" class="loading" style="display: none;">
            Loading data...
        </div>
        
        <div id="stats" class="stats" style="display: none;"></div>
        
        <div id="charts" class="charts" style="display: none;"></div>
        
        <!-- Tab Navigation -->
        <div class="tabs" style="display: none;">
            <button class="tab-button active" onclick="switchTab('productByDay')">üéÇ Product by Day</button>
            <button class="tab-button" onclick="switchTab('orderDetails')">üìã Order Details</button>
        </div>
        
        <!-- Product by Day Tab -->
        <div id="productByDayTab" class="tab-content data-table" style="display: none;">
            <h2>üéÇ Product by Day</h2>
            <div class="btn-group">
                <button onclick="printProductByDayReport()">üñ®Ô∏è Print Report</button>
                <button onclick="exportProductByDayCSV()">üì• Download CSV</button>
            </div>
            <div id="productByDayContent"></div>
        </div>
        
        <!-- Order Details Tab -->
        <div id="orderDetailsTab" class="tab-content data-table" style="display: none;">
            <h2>üìã Order Details</h2>
            <div class="btn-group">
                <button onclick="printReport()">üñ®Ô∏è Print Report</button>
                <button onclick="exportCSV()">üì• Download CSV</button>
                <button onclick="exportPDF()">üìÑ Download PDF</button>
                <button onclick="exportXLS()">üìä Download Excel</button>
            </div>
            <div id="tableContent"></div>
        </div>
    </div>
    
    <script>
        // Use localhost API for local development, or relative path for production
        const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' 
            ? 'http://localhost:5001/api' 
            : window.location.origin + '/api';
        let currentData = [];
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadDateRanges();
            await loadProducts();
            await loadOrderTypes();
            await loadPickupDates();
            await loadData();
        });
        
        function setQuickDateFilter(filterType, buttonElement) {
            const today = new Date();
            const dateStartInput = document.getElementById('dateStart');
            const dateEndInput = document.getElementById('dateEnd');
            
            // Remove active class from all buttons
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            let startDate, endDate;
            
            switch(filterType) {
                case 'today':
                    startDate = new Date(today);
                    endDate = new Date(today);
                    break;
                case '7days':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 6); // Last 7 days including today
                    endDate = new Date(today);
                    break;
                case '30days':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 29); // Last 30 days including today
                    endDate = new Date(today);
                    break;
                case 'mtd':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1); // First day of current month
                    endDate = new Date(today);
                    break;
            }
            
            // Format dates as YYYY-MM-DD
            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };
            
            dateStartInput.value = formatDate(startDate);
            dateEndInput.value = formatDate(endDate);
            
            // Add active class to clicked button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            
            // Automatically apply filters
            loadData();
        }
        
        async function loadDateRanges() {
            try {
                const response = await fetch(`${API_BASE}/date-range`);
                const result = await response.json();

                if (result.success) {
                    const dr = result.date_range;
                    if (dr.order_date_min) {
                        // Set min/max attributes but leave values blank (all dates by default)
                        document.getElementById('dateStart').min = dr.order_date_min;
                        document.getElementById('dateStart').value = '';
                        document.getElementById('dateEnd').max = dr.order_date_max;
                        document.getElementById('dateEnd').value = '';
                    }
                }
            } catch (error) {
                console.error('Error loading date ranges:', error);
            }
        }
        
        let pickupDateCalendar = null;
        
        async function loadPickupDates() {
            try {
                const response = await fetch(`${API_BASE}/pickup-dates`);
                const result = await response.json();
                
                if (result.success && result.pickup_dates) {
                    allPickupDates = result.pickup_dates;
                    
                    // Initialize Flatpickr calendar
                    const calendarInput = document.getElementById('pickupDateCalendar');
                    
                    // Convert dates to Date objects for Flatpickr
                    const availableDates = allPickupDates.map(dateStr => {
                        const [year, month, day] = dateStr.split('-').map(Number);
                        return new Date(year, month - 1, day);
                    });
                    
                    // Initialize Flatpickr with multi-date selection
                    pickupDateCalendar = flatpickr(calendarInput, {
                        mode: "multiple",
                        dateFormat: "Y-m-d",
                        enable: availableDates, // Only enable available dates
                        defaultDate: [], // Start with no dates selected (all dates)
                        inline: false,
                        allowInput: false,
                        clickOpens: true,
                        onChange: function(selectedDates, dateStr, instance) {
                            updatePickupDateDisplay(selectedDates);
                            // Auto-apply filters when dates change
                            loadData();
                        },
                        onReady: function(selectedDates, dateStr, instance) {
                            // Style the calendar
                            const calendar = instance.calendarContainer;
                            if (calendar) {
                                calendar.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif";
                            }
                        }
                    });
                    
                    // Update display initially
                    updatePickupDateDisplay([]);
                }
            } catch (error) {
                console.error('Error loading pickup dates:', error);
            }
        }
        
        function updatePickupDateDisplay(selectedDates) {
            const countElement = document.getElementById('pickupDateCount');
            const inputElement = document.getElementById('pickupDateCalendar');
            
            if (!selectedDates || selectedDates.length === 0) {
                // All dates selected (default)
                selectedPickupDates = new Set(['all']);
                countElement.textContent = 'All dates selected';
                inputElement.value = '';
            } else {
                // Specific dates selected
                selectedPickupDates = new Set(selectedDates.map(date => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }));
                
                if (selectedDates.length === 1) {
                    const date = selectedDates[0];
                    countElement.textContent = date.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });
                } else {
                    countElement.textContent = `${selectedDates.length} dates selected`;
                }
            }
        }
        
        let selectedProducts = new Set(['All Products']);
        let selectedPickupDates = new Set(['all']); // 'all' means no filter, show all dates
        let selectedOrderTypes = new Set(['All Order Types']);
        
        let allProducts = []; // Store all products for filtering
        let allOrderTypes = []; // Store all order types for filtering
        let currentTotalItems = 0; // Store total line items for table summaries
        
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/products`);
                const result = await response.json();
                
                if (result.success) {
                    allProducts = result.products; // Store all products
                    const optionsList = document.getElementById('productOptionsList');
                    // Clear existing options except "All Products"
                    optionsList.innerHTML = `
                        <label class="multiselect-option">
                            <input type="checkbox" value="All Products" checked onchange="handleProductSelect(this, true)">
                            <span>All Products</span>
                        </label>
                    `;
                    
                    result.products.forEach(product => {
                        const label = document.createElement('label');
                        label.className = 'multiselect-option';
                        label.setAttribute('data-product', product.toLowerCase());
                        
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = product;
                        checkbox.onchange = () => handleProductSelect(checkbox, false);
                        
                        const span = document.createElement('span');
                        span.textContent = product;
                        
                        label.appendChild(checkbox);
                        label.appendChild(span);
                        optionsList.appendChild(label);
                    });
                }
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        async function loadOrderTypes() {
            try {
                const response = await fetch(`${API_BASE}/data`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    // Extract unique order types from the data
                    const orderTypes = new Set();
                    result.data.forEach(row => {
                        if (row['Order Type '] && row['Order Type '].trim()) {
                            orderTypes.add(row['Order Type '].trim());
                        }
                    });
                    
                    allOrderTypes = Array.from(orderTypes).sort();
                    const optionsList = document.getElementById('orderTypeOptionsList');
                    // Clear existing options except "All Order Types"
                    optionsList.innerHTML = `
                        <label class="multiselect-option">
                            <input type="checkbox" value="All Order Types" checked onchange="handleOrderTypeSelect(this, true)">
                            <span>All Order Types</span>
                        </label>
                    `;

                    allOrderTypes.forEach(orderType => {
                        const label = document.createElement('label');
                        label.className = 'multiselect-option';
                        label.setAttribute('data-order-type', orderType.toLowerCase());

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = orderType;
                        checkbox.onchange = () => handleOrderTypeSelect(checkbox, false);

                        const span = document.createElement('span');
                        span.textContent = orderType;

                        label.appendChild(checkbox);
                        label.appendChild(span);
                        optionsList.appendChild(label);
                    });
                }
            } catch (error) {
                console.error('Error loading order types:', error);
            }
        }
        
        function toggleOrderTypeDropdown() {
            const options = document.getElementById('orderTypeOptions');
            if (options.style.display === 'none') {
                options.style.display = 'block';
                document.getElementById('orderTypeSearch').focus();
            } else {
                options.style.display = 'none';
            }
        }
        
        function handleOrderTypeSelect(checkbox, isAllOption) {
            if (isAllOption) {
                if (checkbox.checked) {
                    // Select all
                    selectedOrderTypes = new Set(['All Order Types']);
                    document.querySelectorAll('#orderTypeOptionsList input[type="checkbox"]').forEach(cb => {
                        cb.checked = cb.value === 'All Order Types';
                    });
                } else {
                    // Can't uncheck "All Order Types"
                    checkbox.checked = true;
                }
            } else {
                // Uncheck "All Order Types" when a specific option is selected
                const allOption = document.querySelector('#orderTypeOptionsList input[value="All Order Types"]');
                if (allOption) {
                    allOption.checked = false;
                    selectedOrderTypes.delete('All Order Types');
                }
                
                if (checkbox.checked) {
                    selectedOrderTypes.add(checkbox.value);
                } else {
                    selectedOrderTypes.delete(checkbox.value);
                    
                    // If no specific options selected, select "All Order Types"
                    if (selectedOrderTypes.size === 0) {
                        selectedOrderTypes.add('All Order Types');
                        const allOption = document.querySelector('#orderTypeOptionsList input[value="All Order Types"]');
                        if (allOption) {
                            allOption.checked = true;
                        }
                    }
                }
            }
            
            updateOrderTypeSelectText();
            loadData();
        }
        
        function updateOrderTypeSelectText() {
            const textElement = document.getElementById('orderTypeSelectText');
            if (selectedOrderTypes.has('All Order Types') || selectedOrderTypes.size === 0) {
                textElement.textContent = 'All Order Types';
            } else if (selectedOrderTypes.size === 1) {
                textElement.textContent = Array.from(selectedOrderTypes)[0];
            } else {
                textElement.textContent = `${selectedOrderTypes.size} order types selected`;
            }
        }
        
        function filterOrderTypes(searchTerm) {
            const optionsList = document.getElementById('orderTypeOptionsList');
            const allLabels = optionsList.querySelectorAll('.multiselect-option');
            const searchLower = searchTerm.toLowerCase().trim();

            allLabels.forEach(label => {
                const orderTypeText = label.querySelector('span').textContent.toLowerCase();
                const isAllOption = label.querySelector('input').value === 'All Order Types';

                // Always show "All Order Types", filter others based on search
                if (isAllOption) {
                    label.style.display = 'flex';
                } else {
                    if (searchLower === '' || orderTypeText.includes(searchLower)) {
                        label.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                    }
                }
            });
        }
        
        function getOrderTypeFilter() {
            if (selectedOrderTypes.has('All Order Types') || selectedOrderTypes.size === 0) {
                return '';
            }
            return Array.from(selectedOrderTypes).join(',');
        }
        
        function filterProducts(searchTerm) {
            const optionsList = document.getElementById('productOptionsList');
            const allLabels = optionsList.querySelectorAll('.multiselect-option');
            const searchLower = searchTerm.toLowerCase().trim();
            
            allLabels.forEach(label => {
                const productText = label.querySelector('span').textContent.toLowerCase();
                const isAllProducts = label.querySelector('input').value === 'All Products';
                
                // Always show "All Products", filter others based on search
                if (isAllProducts) {
                    label.style.display = 'flex';
                } else {
                    if (searchLower === '' || productText.includes(searchLower)) {
                        label.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                    }
                }
            });
        }
        
        function toggleProductDropdown() {
            const dropdown = document.getElementById('productMultiselect');
            const options = document.getElementById('productOptions');
            dropdown.classList.toggle('open');
            const isOpening = options.style.display === 'none';
            options.style.display = isOpening ? 'flex' : 'none';
            
            // Clear search when closing dropdown
            if (!isOpening) {
                const searchInput = document.getElementById('productSearch');
                if (searchInput) {
                    searchInput.value = '';
                    filterProducts('');
                }
            } else {
                // Focus search input when opening
                setTimeout(() => {
                    const searchInput = document.getElementById('productSearch');
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
            }
        }
        
        function handleProductSelect(checkbox, isAllProducts) {
            if (isAllProducts) {
                if (checkbox.checked) {
                    // Select all products
                    selectedProducts = new Set(['All Products']);
                    document.querySelectorAll('#productOptionsList input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                    });
                    updateProductSelectText();
                } else {
                    // Can't uncheck "All Products" - it's the default
                    checkbox.checked = true;
                }
            } else {
                if (checkbox.checked) {
                    selectedProducts.add(checkbox.value);
                    // If any specific product is selected, uncheck "All Products"
                    const allProductsCheckbox = document.querySelector('#productOptionsList input[value="All Products"]');
                    if (allProductsCheckbox && allProductsCheckbox.checked) {
                        allProductsCheckbox.checked = false;
                        selectedProducts.delete('All Products');
                    }
                } else {
                    selectedProducts.delete(checkbox.value);
                    // If no products selected, select "All Products"
                    if (selectedProducts.size === 0) {
                        const allProductsCheckbox = document.querySelector('#productOptionsList input[value="All Products"]');
                        if (allProductsCheckbox) {
                            allProductsCheckbox.checked = true;
                            selectedProducts.add('All Products');
                        }
                    }
                }
                updateProductSelectText();
            }
        }
        
        function updateProductSelectText() {
            const textElement = document.getElementById('productSelectText');
            if (selectedProducts.has('All Products') || selectedProducts.size === 0) {
                textElement.textContent = 'All Products';
            } else if (selectedProducts.size === 1) {
                textElement.textContent = Array.from(selectedProducts)[0];
            } else {
                textElement.textContent = `${selectedProducts.size} products selected`;
            }
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('productMultiselect');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
                document.getElementById('productOptions').style.display = 'none';
            }
        });
        
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            
            try {
                // Get selected products - if "All Products" is selected, send empty string
                let productFilter = '';
                if (!selectedProducts.has('All Products') && selectedProducts.size > 0) {
                    // For multiple products, we'll filter on the backend
                    // Send comma-separated list or handle in API
                    productFilter = Array.from(selectedProducts).join(',');
                }
                
                // Get selected pickup dates - if "all" is selected, send empty string
                let pickupDateFilter = '';
                if (!selectedPickupDates.has('all') && selectedPickupDates.size > 0) {
                    // Send comma-separated list of dates
                    pickupDateFilter = Array.from(selectedPickupDates).join(',');
                }
                
                const filters = {
                    date_start: document.getElementById('dateStart').value,
                    date_end: document.getElementById('dateEnd').value,
                    product: productFilter,
                    pickup_dates: pickupDateFilter,
                    order_type: getOrderTypeFilter(),
                };
                
                // Build query string
                const params = new URLSearchParams();
                Object.entries(filters).forEach(([key, value]) => {
                    if (value) params.append(key, value);
                });
                
                // Load summary and data in parallel
                const [summaryRes, dataRes] = await Promise.all([
                    fetch(`${API_BASE}/summary?${params}`),
                    fetch(`${API_BASE}/data?${params}`)
                ]);
                
                // Check for rate limit errors
                if (summaryRes.status === 429 || dataRes.status === 429) {
                    const errorData = await (summaryRes.status === 429 ? summaryRes : dataRes).json();
                    throw new Error(errorData.error || 'Google Sheets API rate limit exceeded. Please wait a minute and refresh.');
                }
                
                const summary = await summaryRes.json();
                const data = await dataRes.json();
                
                if (!summary.success || !data.success) {
                    if (summary.rate_limited || data.rate_limited) {
                        throw new Error('Google Sheets API rate limit exceeded. Please wait a minute and refresh.');
                    }
                    throw new Error(summary.error || data.error || 'Failed to load data');
                }
                
                currentData = data.data;
                currentTotalItems = summary.summary.total_items; // Store total items for table summaries
                
                displaySummary(summary);
                displayTable(data.data);
                displayProductByDay(data.data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('stats').style.display = 'grid';
                // Charts removed - no longer displaying charts
                
                // Show tabs and default to Product by Day tab
                document.querySelector('.tabs').style.display = 'flex';
                document.getElementById('productByDayTab').style.display = 'block';
                document.getElementById('productByDayTab').classList.add('active');
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                let errorMsg = error.message;
                if (errorMsg.includes('429') || errorMsg.includes('rate limit') || errorMsg.includes('RESOURCE_EXHAUSTED') || errorMsg.includes('quota')) {
                    errorMsg = '‚ö†Ô∏è Google Sheets API rate limit exceeded (60 requests/minute). Please wait a minute and refresh the page. Data is cached for 5 minutes to reduce API calls.';
                }
                document.getElementById('errorMessage').textContent = `Error: ${errorMsg}`;
            }
        }
        
        function displaySummary(summary) {
            const stats = summary.summary;
            const statsHtml = `
                <div class="stat-card">
                    <h3>Total Orders</h3>
                    <div class="value">${stats.total_orders.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Line Items</h3>
                    <div class="value">${stats.total_items.toLocaleString()}</div>
                </div>
            `;
            document.getElementById('stats').innerHTML = statsHtml;
        }
        
        function displayCharts(summary) {
            // Ensure charts container exists
            const chartsContainer = document.getElementById('charts');
            if (!chartsContainer) {
                console.error('Charts container not found');
                return;
            }
            
            // Build charts HTML first
            const chartsHtml = `
                <div class="chart-container">
                    <h3>Sales by Product (Top 10)</h3>
                    <div id="productChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Sales by Order Type</h3>
                    <div id="orderTypeChart"></div>
                </div>
            `;
            chartsContainer.innerHTML = chartsHtml;
            
            // Ensure charts container is visible before rendering
            chartsContainer.style.display = 'grid';
            
            // Wait for DOM to update, then render charts
            setTimeout(() => {
                try {
                    // Product chart (Top 10)
                    if (summary.product_sales && summary.product_sales.length > 0) {
                        const productDiv = document.getElementById('productChart');
                        if (productDiv) {
                            const productData = summary.product_sales.map(item => ({
                                x: item['Product Description'],
                                y: item['Subtotal (Calculated)'] || 0
                            }));
                            
                            // Sort by revenue descending (already sorted from API, but ensure)
                            productData.sort((a, b) => b.y - a.y);
                            
                            const productTrace = {
                                x: productData.map(d => d.y), // Revenue on x-axis for horizontal bars
                                y: productData.map(d => d.x), // Product names on y-axis
                                type: 'bar',
                                orientation: 'h', // Horizontal bars
                                marker: { color: '#667eea' }
                            };
                            
                            Plotly.newPlot('productChart', [productTrace], {
                                title: 'Top 10 Products by Revenue',
                                xaxis: { 
                                    title: '',
                                    showticklabels: false,  // Hide revenue numbers on x-axis
                                    showgrid: false
                                },
                                yaxis: { title: 'Product' },
                                showlegend: false,
                                hovermode: false  // Disable hover tooltips that show revenue
                            }, {responsive: true});
                        }
                    }
                    
                    // Order type pie chart
                    if (summary.order_type_sales && summary.order_type_sales.length > 0) {
                        const orderTypeDiv = document.getElementById('orderTypeChart');
                        if (orderTypeDiv) {
                            const pieTrace = {
                                labels: summary.order_type_sales.map(item => item['Order Type ']),
                                values: summary.order_type_sales.map(item => item.Total || 0),
                                type: 'pie'
                            };
                            
                            Plotly.newPlot('orderTypeChart', [pieTrace], {
                                title: 'Revenue by Order Type'
                            }, {responsive: true});
                        }
                    }
                } catch (error) {
                    console.error('Error rendering charts:', error);
                }
            }, 200);
        }
        
        function displayTable(data) {
            if (data.length === 0) {
                document.getElementById('tableContent').innerHTML = '<p>No data available for the selected filters.</p>';
                return;
            }
            
            // Define column order - Due Pickup Date first, Due Pickup Time second, OrderID last
            const columnOrder = [
                'Due Pickup Date', // First column
                'Due Pickup Time', // Second column
                'Customer First Name', // Will combine with Last Name
                'Customer Last Name', // Will be combined with First Name
                'Product Description',
                'Order Date',
                'OrderID' // Last column
            ];
            
            // Columns to hide/exclude
            const hiddenColumns = ['Category', 'Order Type ', 'Notes', 'Note', 'Customer Notes', 'Order Notes', 'Special Instructions', 'Instructions', 'Unit Price', 'Total', 'Subtotal (Calculated)'];
            
            // Get available columns from first record, excluding hidden columns
            const availableColumns = columnOrder.filter(col => 
                col in data[0] && !hiddenColumns.includes(col)
            );
            
            // First, group by OrderID to identify orders with multiple line items
            const ordersByID = {};
            data.forEach(row => {
                const orderID = row['OrderID'] || '';
                if (!ordersByID[orderID]) {
                    ordersByID[orderID] = [];
                }
                ordersByID[orderID].push(row);
            });
            
            // Group orders by Due Pickup Date
            const groupedByDate = {};
            Object.keys(ordersByID).forEach(orderID => {
                const orderRows = ordersByID[orderID];
                const firstRow = orderRows[0];
                const pickupDate = firstRow['Due Pickup Date'] || '';
                
                let dateKey = 'No Date';
                if (pickupDate) {
                    try {
                        // Handle both Date objects and date strings
                        let date;
                        if (pickupDate instanceof Date) {
                            date = pickupDate;
                        } else if (typeof pickupDate === 'string' && pickupDate.match(/^\d{4}-\d{2}-\d{2}/)) {
                            // YYYY-MM-DD format
                            const [year, month, day] = pickupDate.split('-').map(Number);
                            date = new Date(year, month - 1, day);
                        } else {
                            date = new Date(pickupDate);
                        }
                        
                        // Format as YYYY-MM-DD for consistent grouping
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        dateKey = `${year}-${month}-${day}`;
                    } catch (e) {
                        dateKey = pickupDate;
                    }
                }
                
                if (!groupedByDate[dateKey]) {
                    groupedByDate[dateKey] = [];
                }
                groupedByDate[dateKey].push({
                    orderID: orderID,
                    rows: orderRows
                });
            });
            
            // Sort dates (ascending - oldest first)
            const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                if (a === 'No Date') return 1;
                if (b === 'No Date') return -1;
                return new Date(a) - new Date(b);
            });
            
            // Build table HTML
            let tableHtml = '<table><thead><tr>';
            // Header row
            availableColumns.forEach(col => {
                if (col === 'Due Pickup Date') {
                    tableHtml += `<th>Due Pickup Date</th>`;
                } else if (col === 'Customer First Name') {
                    tableHtml += `<th>Customer Name</th>`;
                } else if (col !== 'Customer Last Name') {
                    const displayName = col.replace('Order Type ', 'Order Type');
                    tableHtml += `<th>${displayName}</th>`;
                }
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Helper function to get weekday name
            const getWeekday = (dateString) => {
                if (!dateString || dateString === 'No Date') return '';
                try {
                    const date = new Date(dateString);
                    const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                    return weekdays[date.getDay()];
                } catch (e) {
                    return '';
                }
            };
            
            // Helper function to format cell value
            const formatCellValue = (value, col) => {
                if (value === null || value === undefined || value === '') {
                    return '';
                } else if (typeof value === 'number') {
                    if (col.includes('Price') || col.includes('Total') || col.includes('Revenue') || col.includes('Subtotal')) {
                        return '$' + value.toFixed(2);
                    } else {
                        return value.toLocaleString();
                    }
                } else if (col === 'Due Pickup Date' || col === 'Order Date') {
                    // Format date columns - show only date, no weekday or time
                    try {
                        let date;
                        if (value instanceof Date) {
                            date = value;
                        } else if (typeof value === 'string') {
                            // Handle various date formats
                            if (value.match(/^\d{4}-\d{2}-\d{2}/)) {
                                // YYYY-MM-DD format
                                const [year, month, day] = value.split('-').map(Number);
                                date = new Date(year, month - 1, day);
                            } else {
                                date = new Date(value);
                            }
                        } else {
                            return value;
                        }
                        
                        // Check if date is valid
                        if (isNaN(date.getTime())) {
                            return value;
                        }
                        
                        // Format as date only: "Nov 11, 2025"
                        return date.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            year: 'numeric'
                        });
                    } catch (e) {
                        return value;
                    }
                } else if (typeof value === 'string' && value.match(/^\d{4}-\d{2}-\d{2}/)) {
                    // Format other date strings without weekday - just show date
                    try {
                        const [year, month, day] = value.split('-').map(Number);
                        const dateObj = new Date(year, month - 1, day);
                        if (isNaN(dateObj.getTime())) {
                            return value;
                        }
                        return dateObj.toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            year: 'numeric'
                        });
                    } catch (e) {
                        return value;
                    }
                }
                return value;
            };
            
            // Build table rows grouped by Due Pickup Date, then by Order
            sortedDates.forEach((dateKey, groupIndex) => {
                const orders = groupedByDate[dateKey];
                
                // Add spacing div before each date group (except first)
                if (groupIndex > 0) {
                    tableHtml += `<tr><td colspan="${availableColumns.filter(c => c !== 'Customer Last Name').length}" style="height: 15px; background-color: #e0e0e0; padding: 0; border: none;"></td></tr>`;
                }
                
                // Get weekday for this date group header
                const weekday = getWeekday(orders[0]?.rows[0]?.['Due Pickup Date'] || dateKey);
                // Format date for header - show weekday prominently
                let headerDateDisplay = dateKey;
                if (dateKey !== 'No Date') {
                    try {
                        // Parse dateKey (should be YYYY-MM-DD format)
                        const [year, month, day] = dateKey.split('-').map(Number);
                        if (!isNaN(year) && !isNaN(month) && !isNaN(day)) {
                            const dateObj = new Date(year, month - 1, day);
                            headerDateDisplay = dateObj.toLocaleDateString('en-US', { 
                                weekday: 'long',
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            });
                        } else if (weekday) {
                            headerDateDisplay = `${dateKey} (${weekday})`;
                        }
                    } catch (e) {
                        if (weekday) {
                            headerDateDisplay = `${dateKey} (${weekday})`;
                        }
                    }
                }
                
                // Add date group header row
                tableHtml += `<tr class="date-group-header"><td colspan="${availableColumns.filter(c => c !== 'Customer Last Name').length}" style="background-color: #f0f0f0; font-weight: bold; padding: 12px; border-bottom: 2px solid #667eea;">Due Pickup Date: ${headerDateDisplay}</td></tr>`;
                
                // Process each order
                orders.forEach((order, orderIndex) => {
                    const orderRows = order.rows;
                    const firstRow = orderRows[0];
                    const isMultiLine = orderRows.length > 1;
                    
                    // Order header row (only if multiple line items, or always show for consistency)
                    if (isMultiLine) {
                        const firstName = firstRow['Customer First Name'] || '';
                        const lastName = firstRow['Customer Last Name'] || '';
                        const fullName = `${firstName} ${lastName}`.trim() || '';
                        
                        tableHtml += '<tr class="order-header-row">';
                        availableColumns.forEach(col => {
                            if (hiddenColumns.includes(col)) {
                                return;
                            } else if (col === 'Due Pickup Date') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${formatCellValue(firstRow[col], col)}</td>`;
                            } else if (col === 'Due Pickup Time') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${formatCellValue(firstRow[col], col)}</td>`;
                            } else if (col === 'Customer First Name') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${fullName}</td>`;
                            } else if (col === 'Customer Last Name') {
                                return;
                            } else if (col === 'Product Description') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8; font-style: italic;">Order: ${orderRows.length} item${orderRows.length > 1 ? 's' : ''}</td>`;
                            } else if (col === 'Order Date') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${formatCellValue(firstRow[col], col)}</td>`;
                            } else if (col === 'OrderID') {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${formatCellValue(firstRow[col], col)}</td>`;
                            } else {
                                tableHtml += `<td style="font-weight: bold; background-color: #e8f4f8;">${formatCellValue(firstRow[col], col)}</td>`;
                            }
                        });
                        tableHtml += '</tr>';
                    }
                    
                    // Line items for this order
                    orderRows.forEach((row, lineIndex) => {
                        const isFirstLine = lineIndex === 0;
                        const rowClass = isMultiLine ? 'line-item-row' : 'single-item-row';
                        const indentStyle = isMultiLine ? 'padding-left: 30px;' : '';
                        
                        tableHtml += `<tr class="${rowClass}" style="background-color: ${isMultiLine ? '#fafafa' : '#ffffff'};">`;
                        availableColumns.forEach(col => {
                            if (hiddenColumns.includes(col)) {
                                return;
                            } else if (col === 'Customer First Name') {
                                // Don't show customer name on line items when there are multiple items (already shown in header)
                                if (isMultiLine) {
                                    tableHtml += `<td style="${indentStyle}">&nbsp;</td>`;
                                } else {
                                    const firstName = row['Customer First Name'] || '';
                                    const lastName = row['Customer Last Name'] || '';
                                    const fullName = `${firstName} ${lastName}`.trim() || '';
                                    tableHtml += `<td>${fullName}</td>`;
                                }
                            } else if (col === 'Customer Last Name') {
                                return;
                            } else if (col === 'Product Description') {
                                tableHtml += `<td style="${indentStyle}">${formatCellValue(row[col], col)}</td>`;
                            } else if (isMultiLine && !isFirstLine) {
                                // For subsequent line items, only show Product Description, others are empty or indented
                                if (col === 'Due Pickup Date' || col === 'Due Pickup Time' || col === 'Order Date' || col === 'OrderID') {
                                    tableHtml += `<td style="${indentStyle}">&nbsp;</td>`;
                                } else {
                                    tableHtml += `<td style="${indentStyle}">${formatCellValue(row[col], col)}</td>`;
                                }
                            } else if (isMultiLine && isFirstLine) {
                                // For first line item in multi-line order, show empty for order-level fields
                                if (col === 'Due Pickup Date' || col === 'Due Pickup Time' || col === 'Order Date' || col === 'OrderID') {
                                    tableHtml += `<td style="${indentStyle}">&nbsp;</td>`;
                                } else {
                                    tableHtml += `<td style="${indentStyle}">${formatCellValue(row[col], col)}</td>`;
                                }
                            } else {
                                tableHtml += `<td>${formatCellValue(row[col], col)}</td>`;
                            }
                        });
                        tableHtml += '</tr>';
                    });
                });
            });
            
            // Add summary totals row at the bottom
            tableHtml += '<tfoot>';
            tableHtml += '<tr style="background-color: #667eea; color: white; font-weight: bold; border-top: 3px solid #5568d3;">';
            availableColumns.forEach((col, idx) => {
                if (col === 'Customer Last Name') {
                    return; // Skip this column
                }
                if (idx === 0) {
                    // First column shows "Total"
                    tableHtml += `<td style="padding: 12px; font-size: 1.1em;">Total</td>`;
                } else if (col === 'Product Description') {
                    // Product Description column shows total line items
                    tableHtml += `<td style="padding: 12px; text-align: center; font-size: 1.1em;">${currentTotalItems.toLocaleString()} Line Items</td>`;
                } else {
                    // Other columns are empty
                    tableHtml += '<td style="padding: 12px;"></td>';
                }
            });
            tableHtml += '</tr>';
            tableHtml += '</tfoot>';
            
            tableHtml += '</table>';
            document.getElementById('tableContent').innerHTML = tableHtml;
        }
        
        function resetFilters() {
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            
            // Reset order type selection
            selectedOrderTypes = new Set(['All Order Types']);
            document.querySelectorAll('#orderTypeOptionsList input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === 'All Order Types';
            });
            updateOrderTypeSelectText();
            
            // Reset product selection
            selectedProducts = new Set(['All Products']);
            document.querySelectorAll('#productOptionsList input[type="checkbox"]').forEach(cb => {
                cb.checked = cb.value === 'All Products';
            });
            updateProductSelectText();
            
            // Reset pickup date selection
            selectedPickupDates = new Set(['all']);
            if (pickupDateCalendar) {
                pickupDateCalendar.clear();
                updatePickupDateDisplay([]);
            }
            
            // Clear quick date filter active state
            document.querySelectorAll('.quick-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            loadData();
        }
        
        function getFilterParams() {
            let productFilter = '';
            if (!selectedProducts.has('All Products') && selectedProducts.size > 0) {
                productFilter = Array.from(selectedProducts).join(',');
            }
            
            // Get selected pickup dates
            let pickupDateFilter = '';
            if (!selectedPickupDates.has('all') && selectedPickupDates.size > 0) {
                pickupDateFilter = Array.from(selectedPickupDates).join(',');
            }
            
            return new URLSearchParams({
                date_start: document.getElementById('dateStart').value || '',
                date_end: document.getElementById('dateEnd').value || '',
                product: productFilter,
                pickup_dates: pickupDateFilter,
                order_type: getOrderTypeFilter()
            });
        }
        
        function exportCSV() {
            if (!currentData || currentData.length === 0) {
                alert('No data to export');
                return;
            }
            
            try {
                const columns = Object.keys(currentData[0]);
                const csv = [
                    columns.join(','),
                    ...currentData.map(row => 
                        columns.map(col => {
                            const value = row[col] || '';
                            return `"${String(value).replace(/"/g, '""')}"`;
                        }).join(',')
                    )
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `orders_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }
        
        function exportPDF() {
            const params = getFilterParams();
            const url = `${API_BASE}/export/pdf?${params}`;
            window.open(url, '_blank');
        }
        
        function exportXLS() {
            const params = getFilterParams();
            const url = `${API_BASE}/export/xls?${params}`;
            const a = document.createElement('a');
            a.href = url;
            a.download = `sales_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function printReport() {
            // Get current filter information for the print header
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            const orderTypeFilter = getOrderTypeFilter();
            const orderTypeText = selectedOrderTypes.has('All Order Types') || selectedOrderTypes.size === 0 
                ? 'All Order Types' 
                : Array.from(selectedOrderTypes).join(', ');
            const productSelect = document.getElementById('productSelect');
            const productText = productSelect ? productSelect.textContent : 'All Products';
            const pickupDateCount = document.getElementById('pickupDateCount');
            const pickupDateText = pickupDateCount ? pickupDateCount.textContent : 'All dates';
            
            // Create a print-friendly version
            const printWindow = window.open('', '_blank');
            const tableContent = document.getElementById('tableContent').innerHTML;
            const statsContent = document.getElementById('stats').innerHTML;
            
            // Build filter summary
            let filterSummary = '<div style="margin-bottom: 20px; padding: 15px; border-bottom: 2px solid #333;">';
            filterSummary += '<h2 style="margin: 0 0 10px 0;">Sales Report</h2>';
            filterSummary += '<div style="font-size: 12px; color: #666;">';
            if (dateStart || dateEnd) {
                filterSummary += `<strong>Order Date:</strong> ${dateStart || 'Start'} to ${dateEnd || 'End'}<br>`;
            }
            if (orderTypeFilter) {
                filterSummary += `<strong>Order Type:</strong> ${orderTypeText}<br>`;
            }
            filterSummary += `<strong>Products:</strong> ${productText}<br>`;
            filterSummary += `<strong>Pickup Dates:</strong> ${pickupDateText}<br>`;
            filterSummary += `<strong>Generated:</strong> ${new Date().toLocaleString()}`;
            filterSummary += '</div></div>';
            
            // Build print HTML
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sales Report - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @media print {
                            @page {
                                margin: 0.5in;
                                size: letter;
                            }
                            body {
                                margin: 0;
                                padding: 0;
                                font-size: 10pt;
                            }
                            .no-print {
                                display: none !important;
                            }
                            table {
                                width: 100%;
                                border-collapse: collapse;
                                page-break-inside: auto;
                            }
                            tr {
                                page-break-inside: avoid;
                                page-break-after: auto;
                            }
                            thead {
                                display: table-header-group;
                            }
                            tfoot {
                                display: table-footer-group;
                            }
                            .date-group-header {
                                page-break-after: avoid;
                                background-color: #f0f0f0 !important;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                        }
                        h1, h2 {
                            margin: 10px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 10px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                            font-size: 9pt;
                        }
                        th {
                            background-color: #667eea;
                            color: white;
                            font-weight: bold;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        tr.date-group-header td {
                            background-color: #f0f0f0 !important;
                            font-weight: bold;
                            border-bottom: 2px solid #667eea;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        tr.order-header-row td {
                            background-color: #e8f4f8 !important;
                            font-weight: bold;
                            -webkit-print-color-adjust: exact;
                            print-color-adjust: exact;
                        }
                        .line-item-row td {
                            padding-left: 30px;
                        }
                    </style>
                </head>
                <body>
                    ${filterSummary}
                    ${statsContent}
                    ${tableContent}
                </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            // Wait for content to load, then print
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
                // Optionally close the window after printing
                // printWindow.close();
            }, 250);
        }
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            if (tabName === 'productByDay') {
                document.getElementById('productByDayTab').style.display = 'block';
                document.getElementById('productByDayTab').classList.add('active');
                document.querySelector('.tab-button[onclick="switchTab(\'productByDay\')"]').classList.add('active');
            } else if (tabName === 'orderDetails') {
                document.getElementById('orderDetailsTab').style.display = 'block';
                document.getElementById('orderDetailsTab').classList.add('active');
                document.querySelector('.tab-button[onclick="switchTab(\'orderDetails\')"]').classList.add('active');
            }
        }
        
        // Display Product by Day report
        function displayProductByDay(data) {
            if (!data || data.length === 0) {
                document.getElementById('productByDayContent').innerHTML = '<p>No data available for the selected filters.</p>';
                return;
            }
            
            // Group data by Due Pickup Date, then by Product Description
            const dayProductMap = {};
            
            data.forEach(row => {
                const product = row['Product Description'] || 'Unknown Product';
                const pickupDate = row['Due Pickup Date'] || '';
                
                // Format date key
                let dateKey = 'No Date';
                let dateDisplay = 'No Date';
                if (pickupDate) {
                    try {
                        let date;
                        if (pickupDate instanceof Date) {
                            date = pickupDate;
                        } else if (typeof pickupDate === 'string' && pickupDate.match(/^\d{4}-\d{2}-\d{2}/)) {
                            const [year, month, day] = pickupDate.split('-').map(Number);
                            date = new Date(year, month - 1, day);
                        } else {
                            date = new Date(pickupDate);
                        }
                        
                        if (!isNaN(date.getTime())) {
                            const year = date.getFullYear();
                            const month = String(date.getMonth() + 1).padStart(2, '0');
                            const day = String(date.getDate()).padStart(2, '0');
                            dateKey = `${year}-${month}-${day}`;
                            
                            // Format date for display with weekday
                            dateDisplay = date.toLocaleDateString('en-US', { 
                                weekday: 'long',
                                month: 'short', 
                                day: 'numeric',
                                year: 'numeric'
                            });
                        }
                    } catch (e) {
                        dateKey = pickupDate;
                        dateDisplay = pickupDate;
                    }
                }
                
                // Initialize date group if needed
                if (!dayProductMap[dateKey]) {
                    dayProductMap[dateKey] = {
                        dateDisplay: dateDisplay,
                        products: {}
                    };
                }
                
                // Count products for this date
                if (!dayProductMap[dateKey].products[product]) {
                    dayProductMap[dateKey].products[product] = 0;
                }
                dayProductMap[dateKey].products[product] += 1;
            });
            
            // Sort dates ascending (oldest first)
            const sortedDates = Object.keys(dayProductMap).sort((a, b) => {
                if (a === 'No Date') return 1;
                if (b === 'No Date') return -1;
                return new Date(a) - new Date(b);
            });
            
            // Build HTML with sections for each day
            let html = '';
            
            sortedDates.forEach((dateKey, dateIndex) => {
                const dayData = dayProductMap[dateKey];
                const products = Object.keys(dayData.products).sort();
                
                // Add spacing between date sections (except first)
                if (dateIndex > 0) {
                    html += '<div style="height: 20px; background-color: #e0e0e0; margin: 20px 0;"></div>';
                }
                
                // Date header
                html += `<div style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #667eea;">`;
                html += `<h3 style="margin: 0; color: #667eea; font-size: 1.2em;">${dayData.dateDisplay}</h3>`;
                html += `</div>`;
                
                // Products table for this day
                html += '<table style="margin-bottom: 20px;">';
                html += '<thead><tr>';
                html += '<th style="text-align: left;">Product Description</th>';
                html += '<th style="text-align: center; width: 100px;">Quantity</th>';
                html += '</tr></thead>';
                html += '<tbody>';
                
                let dayTotal = 0;
                products.forEach(product => {
                    const count = dayData.products[product];
                    dayTotal += count;
                    html += '<tr>';
                    html += `<td>${product}</td>`;
                    html += `<td style="text-align: center; font-weight: bold;">${count}</td>`;
                    html += '</tr>';
                });
                
                // Day total row
                html += '<tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #667eea;">';
                html += '<td style="padding-top: 10px;">Total</td>';
                html += `<td style="text-align: center; padding-top: 10px;">${dayTotal}</td>`;
                html += '</tr>';
                
                html += '</tbody></table>';
            });
            
            // Add summary totals at the bottom
            html += '<div style="margin-top: 30px; padding: 15px; background-color: #667eea; color: white; border-radius: 5px; text-align: center; font-weight: bold; font-size: 1.1em;">';
            html += `Total Line Items: ${currentTotalItems.toLocaleString()}`;
            html += '</div>';
            
            document.getElementById('productByDayContent').innerHTML = html;
        }
        
        // Export Product by Day CSV
        function exportProductByDayCSV() {
            const content = document.getElementById('productByDayContent');
            if (!content) return;
            
            const csv = [];
            csv.push('Date,Product Description,Quantity');
            
            // Extract data from the HTML structure
            const daySections = content.querySelectorAll('div[style*="background-color: #f0f0f0"]');
            daySections.forEach(dayHeader => {
                const dateText = dayHeader.querySelector('h3').textContent.trim();
                const table = dayHeader.nextElementSibling;
                
                if (table && table.tagName === 'TABLE') {
                    const rows = table.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length === 2) {
                            const product = cells[0].textContent.trim();
                            const quantity = cells[1].textContent.trim();
                            // Skip total rows
                            if (product !== 'Total') {
                                csv.push(`"${dateText}","${product.replace(/"/g, '""')}",${quantity}`);
                            }
                        }
                    });
                }
            });
            
            if (csv.length <= 1) {
                alert('No data to export');
                return;
            }
            
            try {
                const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `product_by_day_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting Product by Day CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        }
        
        // Print Product by Day Report
        function printProductByDayReport() {
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            const orderTypeFilter = getOrderTypeFilter();
            const orderTypeText = selectedOrderTypes.has('All Order Types') || selectedOrderTypes.size === 0 
                ? 'All Order Types' 
                : Array.from(selectedOrderTypes).join(', ');
            const productSelect = document.getElementById('productSelectText');
            const productText = productSelect ? productSelect.textContent : 'All Products';
            const pickupDateCount = document.getElementById('pickupDateCount');
            const pickupDateText = pickupDateCount ? pickupDateCount.textContent : 'All dates';
            
            const printWindow = window.open('', '_blank');
            const content = document.getElementById('productByDayContent').innerHTML;
            
            let filterSummary = '<div style="margin-bottom: 20px; padding: 15px; border-bottom: 2px solid #333;">';
            filterSummary += '<h2 style="margin: 0 0 10px 0;">Product by Day Report</h2>';
            filterSummary += '<div style="font-size: 12px; color: #666;">';
            if (dateStart || dateEnd) {
                filterSummary += `<strong>Order Date:</strong> ${dateStart || 'Start'} to ${dateEnd || 'End'}<br>`;
            }
            if (orderTypeFilter) {
                filterSummary += `<strong>Order Type:</strong> ${orderTypeText}<br>`;
            }
            filterSummary += `<strong>Products:</strong> ${productText}<br>`;
            filterSummary += `<strong>Pickup Dates:</strong> ${pickupDateText}<br>`;
            filterSummary += `<strong>Generated:</strong> ${new Date().toLocaleString()}`;
            filterSummary += '</div></div>';
            
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Product by Day Report - ${new Date().toLocaleDateString()}</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; size: letter; }
                            body { margin: 0; padding: 0; font-size: 10pt; }
                            .day-section { page-break-inside: avoid; }
                        }
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 9pt; }
                        th { background-color: #667eea; color: white; font-weight: bold; }
                        .day-header { background-color: #f0f0f0; padding: 15px; border-left: 4px solid #667eea; margin-bottom: 15px; }
                        .day-header h3 { margin: 0; color: #667eea; font-size: 1.2em; }
                        .day-spacer { height: 20px; background-color: #e0e0e0; margin: 20px 0; }
                    </style>
                </head>
                <body>
                    ${filterSummary}
                    ${content}
                </body>
                </html>
            `;
            
            printWindow.document.write(printHTML);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }
    </script>
</body>
</html>

